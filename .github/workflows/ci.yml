name: CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'crates/dioxus-poc/**'
      - 'infra-as-code/**'
      - '*.md'
      - '.github/workflows/integration*.yml'
      - '.github/workflows/container-scan.yml'
      - '.github/workflows/embeddings-docker.yml'
      - 'crates/k8s-operator/config/*'
      - 'crates/static-website/**'
      - 'crates/deploy-mcp/**'
      - Justfile
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'crates/dioxus-poc/**'
      - 'infra-as-code/**'
      - '*.md'
      - '.github/workflows/integration*.yml'
      - '.github/workflows/container-scan.yml'
      - '.github/workflows/embeddings-docker.yml'
      - 'crates/k8s-operator/config/*'
      - 'crates/static-website/**'
      - 'crates/deploy-mcp/**'
      - Justfile

jobs:
  summary-check:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      FORCE_COLOR: 1
    steps:
      - uses: actions/checkout@v4
      - name: Run Dagger build
        id: dagger
        continue-on-error: true
        run: cargo run -p dagger-pipeline --release -- all
        env:
          DAGGER_LOG_FORMAT: plain
      - name: Verify SUMMARY.md exists
        run: |
          if [ -f SUMMARY.md ]; then
            echo "SUMMARY.md found."
          else
            echo "SUMMARY.md not found." >&2
            exit 1
          fi
      - name: Publish quality summary
        if: always()
        run: |
          if [ -f SUMMARY.md ]; then
            cat SUMMARY.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Quality summary not available (SUMMARY.md missing)." >> "$GITHUB_STEP_SUMMARY"
          fi
          mkdir -p out
          cp SUMMARY.md out/summary.md || true
      - name: Sticky PR Comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "Dagger CI Summary"
          path: out/summary.md
