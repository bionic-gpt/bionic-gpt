# Pulumi deployment setup

name: bionic-gpt
description: BionicGPT Infrastructure as Code
runtime: yaml
variables:
    namespace: bionic-gpt
    appLabels:
        app: app
    authLabels:
        app: auth
    envoyLabels:
        app: envoy
    version: 1.4.6
    hash-bionicgpt: sha256:6c14637d1587fdd22f83935c7b8d5c8f1748d55e647af481e86a54922004e0f9
    hash-bionicgpt-envoy: sha256:7b3e696d0baeaab30e55cce0a23bbf7e635a72b0c1e03d34ac91be62539f2471
    hash-bionicgpt-pipeline-job: sha256:fc9aa462a3f22bb57cf3d09a89d34dd00f5b55880acab1ea24b8a35941932d64
    hash-bionicgpt-db-migrations: sha256:d0a6dce1f3e2e1ec14f2e81b26f7d2a64de4d5440a48c70315604114a9ea18de
    db-migrations: ghcr.io/bionic-gpt/bionicgpt-db-migrations:${version}@${hash-bionicgpt-db-migrations}
    server: ghcr.io/bionic-gpt/bionicgpt:${version}@${hash-bionicgpt}
    envoy: ghcr.io/bionic-gpt/bionicgpt-envoy:${version}@${hash-bionicgpt-envoy}
    pipeline-job: ghcr.io/bionic-gpt/bionicgpt-pipeline-job:${version}@${hash-bionicgpt-pipeline-job}

resources:
    envoy-deployment:
        type: kubernetes:apps/v1:Deployment
        properties:
            metadata:
                name: envoy
                namespace: ${namespace}
            spec:
                selector:
                    matchLabels: ${envoyLabels}
                replicas: 1
                template:
                    metadata:
                        labels: ${envoyLabels}
                    spec:
                        containers:
                            - name: envoy
                              image: ${envoy}
                              ports:
                                - containerPort: 7700

    auth-deployment:
        type: kubernetes:apps/v1:Deployment
        properties:
            metadata:
                name: auth
                namespace: ${namespace}
            spec:
                selector:
                    matchLabels: ${authLabels}
                replicas: 1
                template:
                    metadata:
                        labels: ${authLabels}
                    spec:
                        containers:
                            - name: auth
                              image: purtontech/barricade:1.2.5
                              ports:
                                - containerPort: 9090
                              env: 
                                - name: DATABASE_URL
                                  valueFrom:
                                    secretKeyRef:
                                        name: database-urls
                                        key: authentication-url
                                - name: SECURE_COOKIE
                                  value: 'true'

                                # Cookie encryption key
                                - name: SECRET_KEY
                                  valueFrom:
                                    secretKeyRef:
                                        name: cookie-encryption
                                        key: cookie-encryption-key

                                - name: REDIRECT_URL
                                  value: /app/post_registration
                                - name: LOGOUT_URL
                                  value: /

                                - name: ENABLE_EMAIL_OTP
                                  value: 'false'

    app-deployment:
        type: kubernetes:apps/v1:Deployment
        properties:
            metadata:
                name: app
                namespace: ${namespace}
            spec:
                selector:
                    matchLabels: ${appLabels}
                replicas: 1
                template:
                    metadata:
                        labels: ${appLabels}
                    spec:
                        containers:
                            - name: app
                              image: ${server}
                              ports:
                                - containerPort: 7403
                              env: 
                                - name: APP_DATABASE_URL
                                  valueFrom:
                                    secretKeyRef:
                                        name: database-urls
                                        key: application-url
                        initContainers:
                            - name: server-init
                              image: ${db-migrations}
                              env: 
                                - name: DATABASE_URL
                                  valueFrom:
                                    secretKeyRef:
                                        name: database-urls
                                        key: migrations-url
    
    # All the required services
    envoy-service:
        properties:
            metadata:
                name: envoy
                namespace: ${namespace}
            spec:
                ports:
                    - port: 7100
                      protocol: TCP
                      targetPort: 7700
                selector:
                    app: envoy
        type: kubernetes:core/v1:Service

    app-service:
        properties:
            metadata:
                name: app
                namespace: ${namespace}
            spec:
                ports:
                    - port: 7703
                      protocol: TCP
                      targetPort: 7703
                selector:
                    app: app
        type: kubernetes:core/v1:Service

    barricade:
        properties:
            metadata:
                name: barricade
                namespace: ${namespace}
            spec:
                ports:
                    - port: 9090
                      protocol: TCP
                      targetPort: 9090
                selector:
                    app: auth
        type: kubernetes:core/v1:Service